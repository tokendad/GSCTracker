---
name: Update Changelog

'on':
  pull_request:
    types: [closed]
    branches:
      - main

jobs:
  update-changelog:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: read

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          ref: main

      - name: Update Changelog
        id: update
        env:
          PR_TITLE: ${{ github.event.pull_request.title }}
          PR_NUMBER: ${{ github.event.pull_request.number }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_BODY: ${{ github.event.pull_request.body }}
          PR_LABELS: ${{ toJSON(github.event.pull_request.labels.*.name) }}
        run: |
          # Determine category based on PR labels or title
          CATEGORY="Changed"

          if echo "$PR_LABELS" | grep -qi "feature\|enhancement"; then
            CATEGORY="Added"
          elif echo "$PR_LABELS" | grep -qi "bug\|fix"; then
            CATEGORY="Fixed"
          elif echo "$PR_LABELS" | grep -qi "security"; then
            CATEGORY="Security"
          elif echo "$PR_LABELS" | grep -qi "breaking"; then
            CATEGORY="Changed"
          elif echo "$PR_LABELS" | grep -qi "deprecated"; then
            CATEGORY="Deprecated"
          elif echo "$PR_LABELS" | grep -qi "removed"; then
            CATEGORY="Removed"
          elif echo "$PR_LABELS" | grep -qi "documentation\|docs"; then
            CATEGORY="Changed"
          fi

          # Fallback: Try to infer from PR title
          if [ "$CATEGORY" = "Changed" ]; then
            if echo "$PR_TITLE" | grep -qiE "^(add|feat|feature)"; then
              CATEGORY="Added"
            elif echo "$PR_TITLE" | grep -qiE "^(fix|bug)"; then
              CATEGORY="Fixed"
            elif echo "$PR_TITLE" | grep -qiE "^(security|sec)"; then
              CATEGORY="Security"
            elif echo "$PR_TITLE" | grep -qiE "^(remove|delete)"; then
              CATEGORY="Removed"
            elif echo "$PR_TITLE" | grep -qiE "^(deprecate)"; then
              CATEGORY="Deprecated"
            fi
          fi

          # Create changelog entry
          ENTRY="- $PR_TITLE ([#$PR_NUMBER]($PR_URL))"

          # Check if CHANGELOG.md exists
          if [ ! -f "CHANGELOG.md" ]; then
            echo "CHANGELOG.md not found. Creating it..."
            cat > CHANGELOG.md << 'EOF'
          # Changelog

          All notable changes to this project will be documented in this file.

          The format is based on [Keep a Changelog](https://keepachangelog.com/en/1.0.0/),
          and this project adheres to [Semantic Versioning](https://semver.org/spec/v2.0.0.html).

          ## [Unreleased]

          ### Added

          ### Changed

          ### Deprecated

          ### Removed

          ### Fixed

          ### Security
          EOF
          fi

          # Find the line number for the category in the Unreleased section
          # Use awk to find the Unreleased section and the appropriate category
          awk -v category="$CATEGORY" -v entry="$ENTRY" '
          BEGIN {
            in_unreleased = 0
            found_category = 0
            printed = 0
          }

          # Match the Unreleased section
          /^## \[Unreleased\]/ {
            in_unreleased = 1
            print
            next
          }

          # Exit Unreleased section when we hit another version
          in_unreleased && /^## \[/ {
            in_unreleased = 0
          }

          # Find the matching category in Unreleased section
          in_unreleased && $0 ~ "^### " category "$" {
            found_category = 1
            print
            next
          }

          # Insert the entry after the category header if we found it and havent printed yet
          in_unreleased && found_category && !printed && /^$/ {
            print entry
            printed = 1
            next
          }

          # Insert before the next category if we found our category but hit another one
          in_unreleased && found_category && !printed && /^### / {
            print entry
            print ""
            printed = 1
          }

          # Print all other lines
          { print }
          ' CHANGELOG.md > CHANGELOG.md.tmp

          mv CHANGELOG.md.tmp CHANGELOG.md

          echo "category=$CATEGORY" >> $GITHUB_OUTPUT
          echo "Updated CHANGELOG.md with entry in $CATEGORY section"

      - name: Commit and Push Changes
        run: |
          git config --local user.email "github-actions[bot]@users.noreply.github.com"
          git config --local user.name "github-actions[bot]"

          if git diff --quiet CHANGELOG.md; then
            echo "No changes to commit"
          else
            git add CHANGELOG.md
            git commit -m "docs: update CHANGELOG.md for PR #${{ github.event.pull_request.number }}"
            git push origin main
          fi
